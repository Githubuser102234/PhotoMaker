<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Photo Maker</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: #121212;
        color: #e0e0e0;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow-x: hidden;
    }

    /* General Styling */
    h1, h2, h3 {
        color: #ffffff;
    }

    button, input[type="file"], select, input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="color"] {
        /* Reset and Base Styles */
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border: none;
        outline: none;
        padding: 12px 20px;
        margin: 5px;
        background: #282828;
        color: #e0e0e0;
        border-radius: 50px; /* Circular for buttons, rounded for others */
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    button:hover, input[type="file"]::-webkit-file-upload-button:hover, select:hover {
        background: #3a3a3a;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    /* Input Specifics */
    input[type="text"], input[type="email"], input[type="password"], input[type="number"] {
        border-radius: 12px;
        width: 250px;
        padding: 12px 15px;
        background: #1e1e1e;
        border: 1px solid #333;
        color: #ffffff;
    }

    input[type="file"] {
        padding: 0;
        background: none;
        width: auto;
    }
    input[type="file"]::-webkit-file-upload-button {
        background: #282828;
        color: #e0e0e0;
        border-radius: 50px;
        padding: 12px 20px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    input[type="file"]::-webkit-file-upload-button:hover {
        background: #3a3a3a;
    }

    /* Color Input (special case) */
    input[type="color"] {
        padding: 5px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #3a3a3a;
        background: none;
    }
    input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
    }
    input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 50%;
    }

    select {
        padding: 12px 15px;
        background: #282828 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="5" viewBox="0 0 10 5"><path fill="%23e0e0e0" d="M0 0l5 5 5-5z"/></svg>') no-repeat right 15px center;
        background-size: 10px 5px;
        border-radius: 12px;
    }

    /* Container Specifics */
    #toolbar {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 10px;
        background: #1e1e1e;
        padding: 15px;
        border-radius: 20px;
        margin: 20px 0;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        max-width: 90%;
    }
    #toolbar label {
        color: #b0b0b0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    canvas {
        border: 2px solid #333;
        background: #1e1e1e;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        max-width: 100%;
        height: auto;
    }

    .canvas-container-wrapper {
        padding: 20px;
        background: #1a1a1a;
        border-radius: 25px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        margin: 20px;
        display: flex;
        justify-content: center;
    }

    /* Auth & Projects */
    #auth-container {
        display: none;
        text-align: center;
        padding: 40px;
        background: #1e1e1e;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        width: 350px;
        max-width: 90%;
    }
    #auth-container input {
        width: 100%;
        margin: 10px 0;
    }
    #auth-container button {
        margin: 5px;
        padding: 12px 25px;
        font-weight: bold;
    }
    #auth-message {
        color: #ff6b6b;
        margin-top: 15px;
        font-size: 14px;
    }

    .projects-page {
        display: none;
        padding: 20px;
        text-align: center;
        width: 100%;
    }
    #my-projects-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        margin-bottom: 20px;
        width: 90%;
        max-width: 1200px;
    }
    #my-projects-header button {
        background: #ff6b6b;
    }
    #my-projects-header button:hover {
        background: #ff8e8e;
    }

    #projects-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
    }
    .project-card, .new-project-btn {
        background: #1e1e1e;
        padding: 20px;
        border-radius: 15px;
        width: 220px;
        height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .project-card:hover, .new-project-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    .new-project-btn {
        font-size: 60px;
        border: 2px dashed #444;
        background: #282828;
        color: #aaa;
        cursor: pointer;
    }
    .project-card a {
        color: #e0e0e0;
        text-decoration: none;
        display: block;
        width: 100%;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .project-card h3 {
        margin: 0;
        font-size: 1.2em;
    }
    .project-card .action-btns {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }
    .project-card .action-btns button {
        padding: 8px;
        margin: 0;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    .project-card .rename-btn {
        background: #3498db;
    }
    .project-card .rename-btn:hover {
        background: #5dade2;
    }
    .project-card .delete-btn {
        background: #e74c3c;
    }
    .project-card .delete-btn:hover {
        background: #ec7063;
    }

    .photo-maker-app {
        display: none;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #project-name-display {
        font-size: 2em;
        margin-top: 20px;
        color: #e0e0e0;
        text-align: center;
        max-width: 90%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Responsive Design */
    @media (max-width: 900px) {
        #toolbar {
            flex-direction: row;
            flex-wrap: wrap;
            padding: 10px;
            gap: 8px;
        }
        button, select, input[type="text"], input[type="email"], input[type="password"] {
            padding: 10px 15px;
            font-size: 14px;
        }
        .project-card, .new-project-btn {
            width: 180px;
            height: 120px;
        }
    }
    @media (max-width: 600px) {
        body {
            justify-content: flex-start;
        }
        #toolbar {
            flex-direction: column;
            width: 90%;
        }
        #toolbar > * {
            width: 90%;
            text-align: center;
            box-sizing: border-box;
        }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"] {
            width: 100%;
        }
        #my-projects-header {
            flex-direction: column;
            width: 100%;
        }
        #my-projects-header h1 {
            margin-bottom: 10px;
        }
        .canvas-container-wrapper {
            padding: 10px;
        }
    }
</style>
</head>
<body>

<div id="auth-container">
    <h2>Login / Sign Up</h2>
    <input type="email" id="auth-email" placeholder="Email">
    <input type="password" id="auth-password" placeholder="Password">
    <button onclick="handleLogin()">Login</button>
    <button onclick="handleSignup()">Sign Up</button>
    <div id="auth-message"></div>
</div>

<div class="projects-page">
    <div id="my-projects-header">
        <h1>My Projects</h1>
        <button onclick="handleLogout()">üö™ Log Out</button>
    </div>
    <div id="projects-container">
        <button class="new-project-btn" onclick="createNewProject()">‚ûï</button>
        <div id="projects-list"></div>
    </div>
</div>

<div class="photo-maker-app">
    <h1 id="project-name-display">Advanced Photo Maker</h1>
    <div id="toolbar">
        <label>Brush: <input type="color" id="brushColor" value="#ff0000"></label>
        <input type="number" id="brushSize" value="5" min="1" max="50">
        <button onclick="toggleDrawing()">‚úèÔ∏è Draw</button>
        <input type="file" id="addImage" accept="image/*">
        <input type="text" id="textInput" placeholder="Add Text...">
        <label>Color: <input type="color" id="textColor" value="#ffffff"></label>
        <input type="number" id="textSize" value="30">
        <select id="textFont">
            <option>Arial</option>
            <option>Comic Sans MS</option>
            <option>Courier New</option>
            <option>Georgia</option>
            <option>Times New Roman</option>
        </select>
        <button onclick="addText()">üî§ Text</button>
        <select id="shapeSelect">
            <option value="">Shape...</option>
            <option value="rect">Rectangle</option>
            <option value="circle">Circle</option>
            <option value="triangle">Triangle</option>
        </select>
        <button onclick="addShape()">‚¨ú Shape</button>
        <select id="stickerSelect">
            <option value="">Sticker...</option>
            <option value="https://i.imgur.com/4AiXzf8.png">Star</option>
            <option value="https://i.imgur.com/3X3QZpM.png">Heart</option>
            <option value="https://i.imgur.com/Oj1N0TQ.png">Smiley</option>
        </select>
        <button onclick="addSticker()">üíñ Sticker</button>
        <select id="filterSelect">
            <option value="">Filter...</option>
            <option value="grayscale">Grayscale</option>
            <option value="sepia">Sepia</option>
            <option value="invert">Invert</option>
            <option value="brightness">Brightness +0.2</option>
        </select>
        <button onclick="applyFilter()">üé® Filter</button>
        <button onclick="bringForward()">‚¨ÜÔ∏è Front</button>
        <button onclick="sendBackward()">‚¨áÔ∏è Back</button>
        <button onclick="undo()">‚Ü©Ô∏è Undo</button>
        <button onclick="redo()">‚Ü™Ô∏è Redo</button>
        <button onclick="deleteObject()">üóëÔ∏è Delete</button>
        <button onclick="saveProject()">üíæ Save</button>
        <button onclick="savePhoto()">üñºÔ∏è Download</button>
        <button onclick="showProjectsPage()">üè† Home</button>
        <button onclick="handleLogout()">üö™ Log Out</button>
    </div>
    <div class="canvas-container-wrapper">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { 
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        doc,
        deleteDoc,
        getDoc,
        setDoc,
        updateDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD77yJuc8wH-gbCwu5EkaFfoxTCQoTfnjY",
      authDomain: "photomaker-16a56.firebaseapp.com",
      projectId: "photomaker-16a56",
      storageBucket: "photomaker-16a56.firebase-d8205.appspot.com",
      messagingSenderId: "277526284183",
      appId: "1:277526284183:web:590add4650c0a5b374a6d2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let canvas;
    let currentProjectId = null;
    let currentUser = null;

    function setupAuthUI() {
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authContainer = document.getElementById('auth-container');
            const projectsPage = document.querySelector('.projects-page');
            const photoMakerApp = document.querySelector('.photo-maker-app');
            
            if (user) {
                authContainer.style.display = 'none';
                handleUrlParams();
            } else {
                authContainer.style.display = 'block';
                projectsPage.style.display = 'none';
                photoMakerApp.style.display = 'none';
                if (canvas) {
                    canvas.dispose();
                    canvas = null;
                }
            }
        });
    }

    async function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');
        if (projectId) {
            currentProjectId = projectId;
            await loadProject(projectId);
            showPhotoMaker();
        } else {
            showProjectsPage();
        }
    }

    window.showProjectsPage = function() {
        document.querySelector('.projects-page').style.display = 'block';
        document.querySelector('.photo-maker-app').style.display = 'none';
        fetchUserProjects();
    }
    
    function showPhotoMaker() {
        document.querySelector('.projects-page').style.display = 'none';
        document.querySelector('.photo-maker-app').style.display = 'block';
        if (!canvas) {
            canvas = new fabric.Canvas('canvas', { backgroundColor: 'transparent', isDrawingMode: false });
            initializeCanvasFunctions();
        }
    }

    async function fetchUserProjects() {
        if (!currentUser) return;
        const projectsList = document.getElementById('projects-list');
        projectsList.innerHTML = '';
        const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
            const project = doc.data();
            const projectCard = document.createElement('div');
            projectCard.className = 'project-card';
            projectCard.innerHTML = `
                <a href="/PhotoMaker/?projectId=${doc.id}">
                    <h3>${project.name}</h3>
                </a>
                <div class="action-btns">
                    <button class="rename-btn" onclick="renameProject('${doc.id}', '${project.name}')">‚úèÔ∏è</button>
                    <button class="delete-btn" onclick="deleteProject('${doc.id}')">üóëÔ∏è</button>
                </div>
            `;
            projectsList.appendChild(projectCard);
        });
    }

    window.createNewProject = async function() {
        if (!currentUser) return;
        const newProjectRef = await addDoc(collection(db, "projects"), {
            name: "New Project",
            ownerId: currentUser.uid,
            data: null
        });
        window.location.href = `/PhotoMaker/?projectId=${newProjectRef.id}`;
    }

    window.deleteProject = async function(projectId) {
        if (confirm("Are you sure you want to delete this project?")) {
            await deleteDoc(doc(db, "projects", projectId));
            fetchUserProjects();
        }
    }

    window.renameProject = async function(projectId, oldName) {
        const newName = prompt("Enter new project name:", oldName);
        if (newName && newName.trim() !== "" && newName !== oldName) {
            const projectRef = doc(db, "projects", projectId);
            await updateDoc(projectRef, { name: newName });
            fetchUserProjects();
        }
    }

    window.saveProject = async function() {
        if (!currentUser || !currentProjectId) return alert("Please create or open a project first.");
        
        const projectRef = doc(db, "projects", currentProjectId);
        await setDoc(projectRef, {
            name: document.getElementById('project-name-display').textContent,
            ownerId: currentUser.uid,
            data: JSON.stringify(canvas)
        });
        alert("Project saved successfully!");
    }

    async function loadProject(projectId) {
        if (!currentUser) return;
        const docRef = doc(db, "projects", projectId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists() && docSnap.data().ownerId === currentUser.uid) {
            const projectData = docSnap.data().data;
            document.getElementById('project-name-display').textContent = docSnap.data().name;
            if (projectData) {
                if (!canvas) {
                    canvas = new fabric.Canvas('canvas', { backgroundColor: 'transparent', isDrawingMode: false });
                    initializeCanvasFunctions();
                }
                canvas.loadFromJSON(projectData, () => canvas.renderAll());
            } else {
                if (!canvas) {
                     canvas = new fabric.Canvas('canvas', { backgroundColor: 'transparent', isDrawingMode: false });
                     initializeCanvasFunctions();
                }
                canvas.clear(); // Clear canvas if project is new
            }
        } else {
            alert("Project not found or you don't have permission to view it.");
            window.location.href = "/PhotoMaker/";
        }
    }

    window.handleLogin = async function() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const messageDiv = document.getElementById('auth-message');
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            messageDiv.textContent = `Login failed: ${error.message}`;
        }
    }

    window.handleSignup = async function() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const messageDiv = document.getElementById('auth-message');
        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            messageDiv.textContent = `Sign Up failed: ${error.message}`;
        }
    }

    window.handleLogout = async function() {
        await signOut(auth);
    }

    document.addEventListener('DOMContentLoaded', setupAuthUI);

    function initializeCanvasFunctions() {
        let state = [];
        let currentStateIndex = -1;

        function saveState() {
            if (currentStateIndex < state.length - 1) {
                state = state.slice(0, currentStateIndex + 1);
            }
            state.push(JSON.stringify(canvas));
            currentStateIndex++;
        }

        window.undo = function() {
            if (currentStateIndex > 0) {
                currentStateIndex--;
                canvas.loadFromJSON(state[currentStateIndex], () => canvas.renderAll());
            }
        };

        window.redo = function() {
            if (currentStateIndex < state.length - 1) {
                currentStateIndex++;
                canvas.loadFromJSON(state[currentStateIndex], () => canvas.renderAll());
            }
        };

        window.deleteObject = function() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length > 0) {
                activeObjects.forEach(obj => canvas.remove(obj));
                canvas.discardActiveObject().renderAll();
                saveState();
            }
        };

        window.savePhoto = function() {
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1.0
            });
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = document.getElementById('project-name-display').textContent + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        canvas.on('object:added', saveState);
        canvas.on('object:modified', saveState);
        canvas.on('object:removed', saveState);
        
        document.getElementById('brushColor').oninput = e => canvas.freeDrawingBrush.color = e.target.value;
        document.getElementById('brushSize').oninput = e => canvas.freeDrawingBrush.width = parseInt(e.target.value, 10);
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);

        window.toggleDrawing = function() {
            canvas.isDrawingMode = !canvas.isDrawingMode;
        };

        document.getElementById('addImage').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    img.scaleToWidth(200);
                    canvas.add(img).centerObject(img).setActiveObject(img);
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        window.addText = function() {
            const textVal = document.getElementById('textInput').value;
            if (!textVal) return;
            const text = new fabric.Textbox(textVal, {
                fill: document.getElementById('textColor').value,
                fontSize: parseInt(document.getElementById('textSize').value),
                fontFamily: document.getElementById('textFont').value,
                left: 100,
                top: 100
            });
            canvas.add(text).setActiveObject(text);
        };

        window.addShape = function() {
            const type = document.getElementById('shapeSelect').value;
            let shape;
            if (type === 'rect') {
                shape = new fabric.Rect({ width: 100, height: 60, fill: 'red', left: 150, top: 150 });
            } else if (type === 'circle') {
                shape = new fabric.Circle({ radius: 50, fill: 'green', left: 150, top: 150 });
            } else if (type === 'triangle') {
                shape = new fabric.Triangle({ width: 100, height: 100, fill: 'blue', left: 150, top: 150 });
            }
            if (shape) canvas.add(shape).setActiveObject(shape);
        };

        window.addSticker = function() {
            const url = document.getElementById('stickerSelect').value;
            if (!url) return;
            fabric.Image.fromURL(url, function(img) {
                img.scaleToWidth(100);
                canvas.add(img).centerObject(img).setActiveObject(img);
            });
        };

        window.applyFilter = function() {
            const filter = document.getElementById('filterSelect').value;
            const obj = canvas.getActiveObject();
            if (!obj || obj.type !== 'image') return alert('Select an image to apply filter.');

            switch(filter) {
                case 'grayscale':
                    obj.filters.push(new fabric.Image.filters.Grayscale());
                    break;
                case 'sepia':
                    obj.filters.push(new fabric.Image.filters.Sepia());
                    break;
                case 'invert':
                    obj.filters.push(new fabric.Image.filters.Invert());
                    break;
                case 'brightness':
                    obj.filters.push(new fabric.Image.filters.Brightness({ brightness: 0.2 }));
                    break;
            }
            obj.applyFilters();
            canvas.renderAll();
        };

        window.bringForward = function() {
            const obj = canvas.getActiveObject();
            if (obj) canvas.bringForward(obj);
        };

        window.sendBackward = function() {
            const obj = canvas.getActiveObject();
            if (obj) canvas.sendBackwards(obj);
        };
    }
</script>
</body>
</html>
