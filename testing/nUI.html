<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Photo Maker</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; margin: 0; padding: 0; }
    
    #toolbar {
        display: flex; flex-wrap: wrap; justify-content: center;
        background: #1e1e1e; padding: 10px;
        border-radius: 50px; /* Circular Toolbar */
        margin: 10px auto;
        max-width: fit-content;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    
    #toolbar > * {
        margin: 5px; padding: 10px 15px;
        font-size: 14px; border-radius: 25px; /* Circular buttons */
        border: none;
        transition: background 0.3s ease, transform 0.2s ease;
    }
    
    button, input[type="color"], select, input[type="number"], input[type="text"], input[type="file"] {
        background: #333; color: white;
    }
    
    button:hover, input[type="color"]:hover, select:hover, input[type="number"]:hover, input[type="text"]:hover { 
        background: #444; cursor: pointer; transform: translateY(-2px); 
    }
    
    input[type="file"] {
        padding: 5px 10px;
        background: #333;
        color: white;
        border-radius: 25px;
        cursor: pointer;
        display: block; /* To apply margin and size properly */
        text-align: center;
    }

    /* Style for file input button text */
    input[type="file"]::-webkit-file-upload-button {
        visibility: hidden;
    }

    input[type="file"]::before {
        content: '‚ûï Image';
        display: inline-block;
        background: #333;
        border-radius: 25px;
        padding: 10px 15px;
        outline: none;
        white-space: nowrap;
        -webkit-user-select: none;
        cursor: pointer;
        color: white;
        font-weight: 700;
        font-size: 14px;
        transition: background 0.3s ease;
    }

    input[type="file"]:hover::before {
        background: #444;
    }
    
    canvas { 
        border: 2px solid #555; 
        background: #2c2c2c; 
        max-width: 100%; 
        height: auto; 
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
    }
    
    #auth-container {
        display: none;
        text-align: center;
        padding: 40px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1e1e1e;
        border-radius: 20px;
        z-index: 100;
        box-shadow: 0 8px 30px rgba(0,0,0,0.7);
    }
    
    #auth-container h2 {
        font-size: 2em;
        margin-bottom: 20px;
    }
    
    #auth-container input {
        display: block;
        width: 300px;
        margin: 15px auto;
        padding: 12px 15px;
        border-radius: 10px;
        border: 1px solid #444;
        background: #2c2c2c;
        color: white;
    }
    
    #auth-container button {
        margin: 10px;
        padding: 12px 24px;
        background: #007bff;
        border-radius: 10px;
        font-weight: bold;
    }
    
    #auth-container button:hover {
        background: #0056b3;
    }
    
    #auth-message {
        color: #ff6b6b;
        margin-top: 15px;
    }
    
    .photo-maker-app {
        display: none;
        padding: 20px;
    }
    
    .projects-page {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .project-card {
        background: #2c2c2c;
        padding: 20px;
        margin: 15px;
        border-radius: 15px;
        display: inline-block;
        width: 250px;
        text-align: left;
        position: relative;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
    }
    
    .project-card:hover {
        transform: translateY(-5px);
    }
    
    .project-card button {
        position: absolute;
        padding: 8px;
        border-radius: 50%; /* Circular button for card */
        background: #555;
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    
    .project-card button:hover {
        background: #777;
    }

    .project-card .delete-btn {
        right: 10px;
        top: 10px;
        background: #e74c3c;
    }
    .project-card .rename-btn {
        right: 50px;
        top: 10px;
        background: #3498db;
    }
    
    .project-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.2em;
    }
    
    .project-card a {
        color: white;
        text-decoration: none;
        display: block;
        padding-right: 80px;
    }

    #my-projects-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
    }
    
    #my-projects-header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
    }
    
    #my-projects-header button {
        padding: 10px 20px;
        border-radius: 25px;
        background: #ff6b6b;
        color: white;
        border: none;
        font-size: 16px;
    }

    #my-projects-header button:hover {
        background: #ff4757;
    }
    
    #projects-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .create-project-btn {
        width: 250px; 
        height: 150px; 
        font-size: 50px; 
        margin: 15px; 
        background: #2c2c2c;
        border-radius: 15px;
        color: #007bff;
        border: 2px dashed #444;
        transition: border-color 0.3s ease, background 0.3s ease;
    }

    .create-project-btn:hover {
        border-color: #007bff;
        background: #222;
    }

    #forgot-password-btn {
        background: none;
        border: none;
        color: #66b3ff;
        font-size: 14px;
        cursor: pointer;
        margin-top: 10px;
    }
    
    #forgot-password-btn:hover {
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        #toolbar {
            flex-direction: column;
            align-items: center;
            border-radius: 20px;
        }
        #toolbar > * {
            width: 90%;
            text-align: center;
        }
        .project-card {
            width: 90%;
            display: block;
            margin: 15px auto;
        }
        #my-projects-header {
            flex-direction: column;
            text-align: center;
        }
        #my-projects-header h1 {
            margin-bottom: 15px;
        }
        .create-project-btn {
            width: 90%;
        }
    }
</style>
</head>
<body>

<div id="auth-container">
    <h2>Login / Sign Up</h2>
    <input type="email" id="auth-email" placeholder="Email">
    <input type="password" id="auth-password" placeholder="Password">
    <button onclick="handleLogin()">Login</button>
    <button onclick="handleSignup()">Sign Up</button>
    <button id="forgot-password-btn" onclick="handlePasswordReset()">Forgot password?</button>
    <div id="auth-message"></div>
</div>

<div class="projects-page">
    <div id="my-projects-header">
        <h1>My Projects</h1>
        <button onclick="handleLogout()">üö™ Log Out</button>
    </div>
    <div id="projects-container">
        <button class="create-project-btn" onclick="createNewProject()">‚ûï</button>
        <div id="projects-list"></div>
    </div>
</div>

<div class="photo-maker-app">
    <h1 id="project-name-display" style="text-align:center;">Advanced Photo Maker</h1>
    <div id="toolbar">
        <label style="color:white; line-height: 40px;">Brush: <input type="color" id="brushColor" value="#ff0000"></label>
        <input type="number" id="brushSize" value="5" min="1" max="50" style="width: 60px; text-align: center;">
        <button onclick="toggleDrawing()">‚úèÔ∏è Draw</button>
        <label for="addImage" style="display: none;"></label>
        <input type="file" id="addImage" accept="image/*" style="width: 150px; text-align: center;">
        <input type="text" id="textInput" placeholder="Text" style="width: 100px;">
        <label style="color:white; line-height: 40px; display: none;">Color: <input type="color" id="textColor" value="#ffffff"></label>
        <input type="number" id="textSize" value="30" style="width: 60px; text-align: center;">
        <select id="textFont">
            <option>Arial</option>
            <option>Comic Sans MS</option>
            <option>Courier New</option>
            <option>Georgia</option>
            <option>Times New Roman</option>
        </select>
        <button onclick="addText()">üî§ Text</button>
        <select id="shapeSelect">
            <option value="">Shape...</option>
            <option value="rect">Rectangle</option>
            <option value="circle">Circle</option>
            <option value="triangle">Triangle</option>
        </select>
        <button onclick="addShape()">‚¨ú Shape</button>
        <select id="stickerSelect">
            <option value="">Sticker...</option>
            <option value="https://i.imgur.com/4AiXzf8.png">Star</option>
            <option value="https://i.imgur.com/3X3QZpM.png">Heart</option>
            <option value="https://i.imgur.com/Oj1N0TQ.png">Smiley</option>
        </select>
        <button onclick="addSticker()">üíñ Sticker</button>
        <select id="filterSelect">
            <option value="">Filter...</option>
            <option value="grayscale">Grayscale</option>
            <option value="sepia">Sepia</option>
            <option value="invert">Invert</option>
            <option value="brightness">Brightness +0.2</option>
        </select>
        <button onclick="applyFilter()">üé® Filter</button>
        <button onclick="bringForward()">‚¨ÜÔ∏è Front</button>
        <button onclick="sendBackward()">‚¨áÔ∏è Back</button>
        <button onclick="undo()">‚Ü©Ô∏è Undo</button>
        <button onclick="redo()">‚Ü™Ô∏è Redo</button>
        <button onclick="deleteObject()">üóëÔ∏è Delete</button>
        <button onclick="saveProject()">üíæ Save to Projects</button>
        <button onclick="savePhoto()">üñºÔ∏è Save Photo</button>
        <button onclick="handleLogout()">üö™ Logout</button>
        <button onclick="showProjectsPage()">üè† Home</button>
    </div>
    <div style="text-align:center;">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged,
        signOut,
        sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { 
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        doc,
        deleteDoc,
        getDoc,
        setDoc,
        updateDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD77yJuc8wH-gbCwu5EkaFfoxTCQoTfnjY",
      authDomain: "photomaker-16a56.firebaseapp.com",
      projectId: "photomaker-16a56",
      storageBucket: "photomaker-16a56.firebase-d8205.appspot.com",
      messagingSenderId: "277526284183",
      appId: "1:277526284183:web:590add4650c0a5b374a6d2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let canvas;
    let currentProjectId = null;
    let currentUser = null;

    function setupAuthUI() {
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authContainer = document.getElementById('auth-container');
            const projectsPage = document.querySelector('.projects-page');
            const photoMakerApp = document.querySelector('.photo-maker-app');
            
            if (user) {
                authContainer.style.display = 'none';
                handleUrlParams();
            } else {
                authContainer.style.display = 'block';
                projectsPage.style.display = 'none';
                photoMakerApp.style.display = 'none';
                if (canvas) {
                    canvas.dispose();
                    canvas = null;
                }
            }
        });
    }

    async function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');
        if (projectId) {
            currentProjectId = projectId;
            await loadProject(projectId);
            showPhotoMaker();
        } else {
            showProjectsPage();
        }
    }

    window.showProjectsPage = function() {
        document.querySelector('.projects-page').style.display = 'block';
        document.querySelector('.photo-maker-app').style.display = 'none';
        fetchUserProjects();
    }
    
    function showPhotoMaker() {
        document.querySelector('.projects-page').style.display = 'none';
        document.querySelector('.photo-maker-app').style.display = 'block';
        if (!canvas) {
            canvas = new fabric.Canvas('canvas', { backgroundColor: 'transparent', isDrawingMode: false });
            initializeCanvasFunctions();
        }
    }

    async function fetchUserProjects() {
    if (!currentUser) return;
    const projectsList = document.getElementById('projects-list');
    projectsList.innerHTML = '';
    const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid));
    const querySnapshot = await getDocs(q);
    querySnapshot.forEach((doc) => {
        const project = doc.data();
        const projectCard = document.createElement('div');
        projectCard.className = 'project-card';
        projectCard.innerHTML = `
            <button class="rename-btn" onclick="renameProject('${doc.id}', '${project.name}')"><img src="https://raw.githubusercontent.com/Githubuser102234/PhotoMaker/refs/heads/main/requiredcontent/IMG_0711.webp" alt="Edit" style="width: 20px; height: 20px;"></button>
            <a href="/PhotoMaker/?projectId=${doc.id}">
                <h3>${project.name}</h3>
            </a>
            <button class="delete-btn" onclick="deleteProject('${doc.id}')"><img src="https://raw.githubusercontent.com/Githubuser102234/PhotoMaker/refs/heads/main/requiredcontent/IMG_0710.png" alt="Delete" style="width: 20px; height: 20px;"></button>
        `;
        projectsList.appendChild(projectCard);
    });
}

    window.createNewProject = async function() {
        if (!currentUser) return;
        const newProjectRef = await addDoc(collection(db, "projects"), {
            name: "New Project",
            ownerId: currentUser.uid,
            data: null
        });
        window.location.href = `/PhotoMaker/?projectId=${newProjectRef.id}`;
    }

    window.deleteProject = async function(projectId) {
        if (confirm("Are you sure you want to delete this project?")) {
            await deleteDoc(doc(db, "projects", projectId));
            fetchUserProjects();
        }
    }

    window.renameProject = async function(projectId, oldName) {
        const newName = prompt("Enter new project name:", oldName);
        if (newName && newName.trim() !== "" && newName !== oldName) {
            const projectRef = doc(db, "projects", projectId);
            await updateDoc(projectRef, { name: newName });
            fetchUserProjects();
        }
    }

    window.saveProject = async function() {
        if (!currentUser || !currentProjectId) return alert("Please create or open a project first.");
        
        const projectRef = doc(db, "projects", currentProjectId);
        await setDoc(projectRef, {
            name: document.getElementById('project-name-display').textContent,
            ownerId: currentUser.uid,
            data: JSON.stringify(canvas)
        });
        alert("Project saved successfully!");
    }

    async function loadProject(projectId) {
        if (!currentUser) return;
        const docRef = doc(db, "projects", projectId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists() && docSnap.data().ownerId === currentUser.uid) {
            const projectData = docSnap.data().data;
            document.getElementById('project-name-display').textContent = docSnap.data().name;
            if (projectData) {
                if (!canvas) {
                    canvas = new fabric.Canvas('canvas', { backgroundColor: 'transparent', isDrawingMode: false });
                    initializeCanvasFunctions();
                }
                canvas.loadFromJSON(projectData, () => canvas.renderAll());
            } else {
                if (!canvas) {
                     canvas = new fabric.Canvas('canvas', { backgroundColor: 'transparent', isDrawingMode: false });
                     initializeCanvasFunctions();
                }
                canvas.clear(); // Clear canvas if project is new
            }
        } else {
            alert("Project not found or you don't have permission to view it.");
            window.location.href = "/PhotoMaker/";
        }
    }

    window.handleLogin = async function() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const messageDiv = document.getElementById('auth-message');
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            messageDiv.textContent = `Login failed: ${error.message}`;
        }
    }

    window.handleSignup = async function() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const messageDiv = document.getElementById('auth-message');
        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            messageDiv.textContent = `Sign Up failed: ${error.message}`;
        }
    }

    window.handlePasswordReset = async function() {
        const email = document.getElementById('auth-email').value;
        const messageDiv = document.getElementById('auth-message');
        if (!email) {
            messageDiv.textContent = "Please enter your email to reset your password.";
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            messageDiv.textContent = "Password reset email sent! Check your inbox.";
            messageDiv.style.color = 'green';
        } catch (error) {
            messageDiv.textContent = `Password reset failed: ${error.message}`;
            messageDiv.style.color = 'red';
        }
    }

    window.handleLogout = async function() {
        await signOut(auth);
    }

    document.addEventListener('DOMContentLoaded', setupAuthUI);

    function initializeCanvasFunctions() {
        let state = [];
        let currentStateIndex = -1;

        function saveState() {
            if (currentStateIndex < state.length - 1) {
                state = state.slice(0, currentStateIndex + 1);
            }
            state.push(JSON.stringify(canvas));
            currentStateIndex++;
        }

        window.undo = function() {
            if (currentStateIndex > 0) {
                currentStateIndex--;
                canvas.loadFromJSON(state[currentStateIndex], () => canvas.renderAll());
            }
        };

        window.redo = function() {
            if (currentStateIndex < state.length - 1) {
                currentStateIndex++;
                canvas.loadFromJSON(state[currentStateIndex], () => canvas.renderAll());
            }
        };

        window.deleteObject = function() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length > 0) {
                activeObjects.forEach(obj => canvas.remove(obj));
                canvas.discardActiveObject().renderAll();
                saveState();
            }
        };

        window.savePhoto = function() {
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1.0
            });
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = document.getElementById('project-name-display').textContent + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        canvas.on('object:added', saveState);
        canvas.on('object:modified', saveState);
        canvas.on('object:removed', saveState);
        
        document.getElementById('brushColor').oninput = e => canvas.freeDrawingBrush.color = e.target.value;
        document.getElementById('brushSize').oninput = e => canvas.freeDrawingBrush.width = parseInt(e.target.value, 10);
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);

        window.toggleDrawing = function() {
            canvas.isDrawingMode = !canvas.isDrawingMode;
        };

        document.getElementById('addImage').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    img.scaleToWidth(200);
                    canvas.add(img).centerObject(img).setActiveObject(img);
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        window.addText = function() {
            const textVal = document.getElementById('textInput').value;
            if (!textVal) return;
            const text = new fabric.Textbox(textVal, {
                fill: document.getElementById('textColor').value,
                fontSize: parseInt(document.getElementById('textSize').value),
                fontFamily: document.getElementById('textFont').value,
                left: 100,
                top: 100
            });
            canvas.add(text).setActiveObject(text);
        };

        window.addShape = function() {
            const type = document.getElementById('shapeSelect').value;
            let shape;
            if (type === 'rect') {
                shape = new fabric.Rect({ width: 100, height: 60, fill: 'red', left: 150, top: 150 });
            } else if (type === 'circle') {
                shape = new fabric.Circle({ radius: 50, fill: 'green', left: 150, top: 150 });
            } else if (type === 'triangle') {
                shape = new fabric.Triangle({ width: 100, height: 100, fill: 'blue', left: 150, top: 150 });
            }
            if (shape) canvas.add(shape).setActiveObject(shape);
        };

        window.addSticker = function() {
            const url = document.getElementById('stickerSelect').value;
            if (!url) return;
            fabric.Image.fromURL(url, function(img) {
                img.scaleToWidth(100);
                canvas.add(img).centerObject(img).setActiveObject(img);
            });
        };

        window.applyFilter = function() {
            const filter = document.getElementById('filterSelect').value;
            const obj = canvas.getActiveObject();
            if (!obj || obj.type !== 'image') return alert('Select an image to apply filter.');

            switch(filter) {
                case 'grayscale':
                    obj.filters.push(new fabric.Image.filters.Grayscale());
                    break;
                case 'sepia':
                    obj.filters.push(new fabric.Image.filters.Sepia());
                    break;
                case 'invert':
                    obj.filters.push(new fabric.Image.filters.Invert());
                    break;
                case 'brightness':
                    obj.filters.push(new fabric.Image.filters.Brightness({ brightness: 0.2 }));
                    break;
            }
            obj.applyFilters();
            canvas.renderAll();
        };

        window.bringForward = function() {
            const obj = canvas.getActiveObject();
            if (obj) canvas.bringForward(obj);
        };

        window.sendBackward = function() {
            const obj = canvas.getActiveObject();
            if (obj) canvas.sendBackwards(obj);
        };
    }
</script>
</body>
</html>
